<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sales Manager Dashboard - Arivu Supply Chain</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="api.js"></script>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-success">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">Arivu Supply Chain</a>
            <span class="navbar-text">Sales Manager Dashboard</span>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <div class="row">
            <!-- Sales Metrics -->
            <div class="col-12 mb-4">
                <div class="row">
                    <div class="col-md-3">
                        <div class="card bg-primary text-white">
                            <div class="card-body">
                                <h5 class="card-title">My Leads</h5>
                                <h2 id="myLeads">-</h2>
                                <small>Assigned to me</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-warning text-white">
                            <div class="card-body">
                                <h5 class="card-title">This Month</h5>
                                <h2 id="monthlyConversions">-</h2>
                                <small>Conversions</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-info text-white">
                            <div class="card-body">
                                <h5 class="card-title">Success Rate</h5>
                                <h2 id="successRate">-</h2>
                                <small>Last 30 days</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-success text-white">
                            <div class="card-body">
                                <h5 class="card-title">Target</h5>
                                <h2 id="targetProgress">-</h2>
                                <small>Monthly goal</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Lead Management -->
            <div class="col-md-8 mb-4">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5>Lead Management</h5>
                        <div>
                            <select id="statusFilter" class="form-select form-select-sm" onchange="filterLeads()">
                                <option value="">All Statuses</option>
                                <option value="new">New</option>
                                <option value="contacted">Contacted</option>
                                <option value="qualified">Qualified</option>
                                <option value="converted">Converted</option>
                                <option value="lost">Lost</option>
                            </select>
                        </div>
                    </div>
                    <div class="card-body">
                        <table class="table table-hover" id="leadsTable">
                            <thead>
                                <tr>
                                    <th>Company</th>
                                    <th>Contact</th>
                                    <th>Phone</th>
                                    <th>Status</th>
                                    <th>Volume</th>
                                    <th>Source</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="col-md-4 mb-4">
                <div class="card">
                    <div class="card-header">
                        <h5>Quick Actions</h5>
                    </div>
                    <div class="card-body">
                        <div class="d-grid gap-2">
                            <button class="btn btn-primary" onclick="showAddLeadModal()">
                                <i class="bi bi-plus-circle"></i> Add New Lead
                            </button>
                            <button class="btn btn-info" onclick="showBulkImport()">
                                <i class="bi bi-upload"></i> Import Leads
                            </button>
                            <button class="btn btn-warning" onclick="scheduleFollowUps()">
                                <i class="bi bi-calendar"></i> Schedule Follow-ups
                            </button>
                            <button class="btn btn-success" onclick="exportLeads()">
                                <i class="bi bi-download"></i> Export Report
                            </button>
                        </div>
                        
                        <hr>
                        
                        <h6>Today's Tasks</h6>
                        <ul class="list-group list-group-flush" id="todayTasks">
                            <li class="list-group-item">Follow up with Fresh Market Groceries</li>
                            <li class="list-group-item">Send proposal to Corner Store Plus</li>
                            <li class="list-group-item">Schedule meeting with Mega Supermart</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Activity Feed -->
            <div class="col-md-6 mb-4">
                <div class="card">
                    <div class="card-header">
                        <h5>Recent Activity</h5>
                    </div>
                    <div class="card-body">
                        <div class="list-group" id="activityFeed">
                            <div class="list-group-item">
                                <div class="d-flex w-100 justify-content-between">
                                    <h6 class="mb-1">Lead Status Updated</h6>
                                    <small>2 hours ago</small>
                                </div>
                                <p class="mb-1">Fresh Market Groceries moved to "Contacted"</p>
                            </div>
                            <div class="list-group-item">
                                <div class="d-flex w-100 justify-content-between">
                                    <h6 class="mb-1">New Lead Added</h6>
                                    <small>4 hours ago</small>
                                </div>
                                <p class="mb-1">Health Food Hub - Website inquiry</p>
                            </div>
                            <div class="list-group-item">
                                <div class="d-flex w-100 justify-content-between">
                                    <h6 class="mb-1">Lead Converted</h6>
                                    <small>1 day ago</small>
                                </div>
                                <p class="mb-1">Organic Market Plus successfully converted</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sales Pipeline -->
            <div class="col-md-6 mb-4">
                <div class="card">
                    <div class="card-header">
                        <h5>Sales Pipeline</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <div class="d-flex justify-content-between">
                                <span>New Leads</span>
                                <span id="newLeadsCount">0</span>
                            </div>
                            <div class="progress">
                                <div class="progress-bar bg-primary" id="newProgress" style="width: 0%"></div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <div class="d-flex justify-content-between">
                                <span>In Contact</span>
                                <span id="contactedLeadsCount">0</span>
                            </div>
                            <div class="progress">
                                <div class="progress-bar bg-info" id="contactedProgress" style="width: 0%"></div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <div class="d-flex justify-content-between">
                                <span>Qualified</span>
                                <span id="qualifiedLeadsCount">0</span>
                            </div>
                            <div class="progress">
                                <div class="progress-bar bg-warning" id="qualifiedProgress" style="width: 0%"></div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <div class="d-flex justify-content-between">
                                <span>Converted</span>
                                <span id="convertedLeadsCount">0</span>
                            </div>
                            <div class="progress">
                                <div class="progress-bar bg-success" id="convertedProgress" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Lead Details Modal -->
    <div class="modal fade" id="leadDetailsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Lead Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="leadDetailsContent">
                    <!-- Lead details will be loaded here -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="editLead()">Edit Lead</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Lead Modal -->
    <div class="modal fade" id="addLeadModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add New Lead</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addLeadForm">
                        <div class="mb-3">
                            <label for="companyName" class="form-label">Company Name</label>
                            <input type="text" class="form-control" id="companyName" required>
                        </div>
                        <div class="mb-3">
                            <label for="contactPerson" class="form-label">Contact Person</label>
                            <input type="text" class="form-control" id="contactPerson" required>
                        </div>
                        <div class="mb-3">
                            <label for="email" class="form-label">Email</label>
                            <input type="email" class="form-control" id="email" required>
                        </div>
                        <div class="mb-3">
                            <label for="phone" class="form-label">Phone</label>
                            <input type="tel" class="form-control" id="phone">
                        </div>
                        <div class="mb-3">
                            <label for="location" class="form-label">Location</label>
                            <input type="text" class="form-control" id="location">
                        </div>
                        <div class="mb-3">
                            <label for="businessType" class="form-label">Business Type</label>
                            <select class="form-control" id="businessType">
                                <option value="">Select...</option>
                                <option value="grocery_store">Grocery Store</option>
                                <option value="supermarket">Supermarket</option>
                                <option value="convenience_store">Convenience Store</option>
                                <option value="restaurant">Restaurant</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="expectedVolume" class="form-label">Expected Volume</label>
                            <select class="form-control" id="expectedVolume">
                                <option value="low">Low</option>
                                <option value="medium" selected>Medium</option>
                                <option value="high">High</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="source" class="form-label">Lead Source</label>
                            <select class="form-control" id="source">
                                <option value="website" selected>Website</option>
                                <option value="referral">Referral</option>
                                <option value="cold_call">Cold Call</option>
                                <option value="trade_show">Trade Show</option>
                                <option value="social_media">Social Media</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="notes" class="form-label">Notes</label>
                            <textarea class="form-control" id="notes" rows="3"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="addLead()">Add Lead</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let allLeads = [];

        async function loadDashboard() {
            try {
                // Load pipeline stats
                const pipelineResp = await fetch('/leads/stats/pipeline');
                const pipelineData = await pipelineResp.json();
                
                updatePipelineProgress(pipelineData);
                updateMetrics(pipelineData);
                
                // Load all leads
                const leadsResp = await fetch('/leads/');
                allLeads = await leadsResp.json();
                displayLeads(allLeads);
                
            } catch (error) {
                console.error('Error loading dashboard:', error);
            }
        }

        function updateMetrics(stats) {
            document.getElementById('myLeads').textContent = stats.total || 0;
            document.getElementById('monthlyConversions').textContent = stats.converted || 0;
            document.getElementById('successRate').textContent = (stats.conversion_rate || 0).toFixed(1) + '%';
            document.getElementById('targetProgress').textContent = '70%'; // Mock data
        }

        function updatePipelineProgress(stats) {
            const total = stats.total || 1;
            
            const counts = {
                new: stats.new || 0,
                contacted: stats.contacted || 0,
                qualified: stats.qualified || 0,
                converted: stats.converted || 0
            };
            
            Object.keys(counts).forEach(status => {
                const percentage = (counts[status] / total) * 100;
                const progressEl = document.getElementById(status + 'Progress');
                const countEl = document.getElementById(status + 'LeadsCount');
                
                if (progressEl) progressEl.style.width = percentage + '%';
                if (countEl) countEl.textContent = counts[status];
            });
        }

        function displayLeads(leads) {
            const tbody = document.querySelector('#leadsTable tbody');
            tbody.innerHTML = '';
            
            leads.forEach(lead => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>
                        <strong>${lead.company_name}</strong><br>
                        <small class="text-muted">${lead.location || 'N/A'}</small>
                    </td>
                    <td>
                        ${lead.contact_person}<br>
                        <small><a href="mailto:${lead.email}">${lead.email}</a></small>
                    </td>
                    <td>${lead.phone || 'N/A'}</td>
                    <td><span class="badge bg-${getStatusColor(lead.status)}">${lead.status}</span></td>
                    <td>${lead.expected_volume}</td>
                    <td>${lead.source}</td>
                    <td>
                        <div class="btn-group btn-group-sm" role="group">
                            <button class="btn btn-outline-primary" onclick="showLeadDetails(${lead.id})">
                                View
                            </button>
                            <button class="btn btn-outline-secondary" onclick="updateLeadStatus(${lead.id}, getNextStatus('${lead.status}'))">
                                ${getStatusAction(lead.status)}
                            </button>
                            ${lead.status === 'qualified' ? `<button class="btn btn-success btn-sm" onclick="convertLead(${lead.id})">Convert</button>` : ''}
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function filterLeads() {
            const statusFilter = document.getElementById('statusFilter').value;
            
            let filteredLeads = allLeads;
            if (statusFilter) {
                filteredLeads = allLeads.filter(lead => lead.status === statusFilter);
            }
            
            displayLeads(filteredLeads);
        }

        function getStatusColor(status) {
            const colors = {
                'new': 'primary',
                'contacted': 'info', 
                'qualified': 'warning',
                'converted': 'success',
                'lost': 'danger'
            };
            return colors[status] || 'secondary';
        }

        function getStatusAction(status) {
            const actions = {
                'new': 'Contact',
                'contacted': 'Qualify',
                'qualified': 'Convert',
                'converted': 'Converted',
                'lost': 'Lost'
            };
            return actions[status] || 'Update';
        }

        function getNextStatus(currentStatus) {
            const nextStatus = {
                'new': 'contacted',
                'contacted': 'qualified',
                'qualified': 'qualified',
                'converted': 'converted',
                'lost': 'lost'
            };
            return nextStatus[currentStatus] || currentStatus;
        }

        async function showLeadDetails(leadId) {
            try {
                const resp = await fetch(`/leads/${leadId}`);
                const lead = await resp.json();
                
                const content = document.getElementById('leadDetailsContent');
                content.innerHTML = `
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Company Information</h6>
                            <p><strong>Company:</strong> ${lead.company_name}</p>
                            <p><strong>Contact Person:</strong> ${lead.contact_person}</p>
                            <p><strong>Email:</strong> ${lead.email}</p>
                            <p><strong>Phone:</strong> ${lead.phone || 'N/A'}</p>
                            <p><strong>Location:</strong> ${lead.location || 'N/A'}</p>
                        </div>
                        <div class="col-md-6">
                            <h6>Lead Details</h6>
                            <p><strong>Business Type:</strong> ${lead.business_type || 'N/A'}</p>
                            <p><strong>Expected Volume:</strong> ${lead.expected_volume}</p>
                            <p><strong>Status:</strong> <span class="badge bg-${getStatusColor(lead.status)}">${lead.status}</span></p>
                            <p><strong>Source:</strong> ${lead.source}</p>
                            <p><strong>Created:</strong> ${new Date(lead.created_at).toLocaleDateString()}</p>
                        </div>
                        <div class="col-12">
                            <h6>Notes</h6>
                            <p>${lead.notes || 'No notes available'}</p>
                        </div>
                    </div>
                `;
                
                const modal = new bootstrap.Modal(document.getElementById('leadDetailsModal'));
                modal.show();
                
            } catch (error) {
                console.error('Error loading lead details:', error);
            }
        }

        async function updateLeadStatus(leadId, newStatus) {
            try {
                const resp = await fetch(`/leads/${leadId}`, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({status: newStatus})
                });
                
                if (resp.ok) {
                    loadDashboard(); // Refresh dashboard
                } else {
                    alert('Failed to update lead status');
                }
            } catch (error) {
                console.error('Error updating lead:', error);
            }
        }

        async function convertLead(leadId) {
            const password = prompt('Enter password for new retailer account:');
            if (!password) return;
            
            try {
                const resp = await fetch(`/leads/${leadId}/convert`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({password: password})
                });
                
                if (resp.ok) {
                    alert('Lead converted successfully!');
                    loadDashboard(); // Refresh dashboard
                } else {
                    const error = await resp.json();
                    alert('Failed to convert lead: ' + error.detail);
                }
            } catch (error) {
                console.error('Error converting lead:', error);
            }
        }

        function showAddLeadModal() {
            const modal = new bootstrap.Modal(document.getElementById('addLeadModal'));
            modal.show();
        }

        async function addLead() {
            const leadData = {
                company_name: document.getElementById('companyName').value,
                contact_person: document.getElementById('contactPerson').value,
                email: document.getElementById('email').value,
                phone: document.getElementById('phone').value,
                location: document.getElementById('location').value,
                business_type: document.getElementById('businessType').value,
                expected_volume: document.getElementById('expectedVolume').value,
                source: document.getElementById('source').value,
                notes: document.getElementById('notes').value,
                assigned_to: 2  // Sales manager ID
            };
            
            try {
                const resp = await fetch('/leads/', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(leadData)
                });
                
                if (resp.ok) {
                    const modal = bootstrap.Modal.getInstance(document.getElementById('addLeadModal'));
                    modal.hide();
                    document.getElementById('addLeadForm').reset();
                    loadDashboard(); // Refresh dashboard
                } else {
                    const error = await resp.json();
                    alert('Failed to add lead: ' + error.detail);
                }
            } catch (error) {
                console.error('Error adding lead:', error);
            }
        }

        // Mock functions for additional features
        function showBulkImport() {
            alert('Bulk import feature - would allow CSV upload of leads');
        }

        function scheduleFollowUps() {
            alert('Follow-up scheduler - would integrate with calendar system');
        }

        function exportLeads() {
            alert('Export feature - would generate CSV/PDF reports');
        }

        function editLead() {
            alert('Edit lead feature - would open edit form');
        }

        // Load dashboard on page load
        loadDashboard();
    </script>
</body>
</html>