<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CEO Dashboard - Arivu Supply Chain</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="api.js"></script>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">Arivu Supply Chain</a>
            <span class="navbar-text">CEO Dashboard</span>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <div class="row">
            <!-- Overview Stats -->
            <div class="col-12 mb-4">
                <div class="row">
                    <div class="col-md-3">
                        <div class="card bg-primary text-white">
                            <div class="card-body">
                                <h5 class="card-title">Total Leads</h5>
                                <h2 id="totalLeads">-</h2>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-success text-white">
                            <div class="card-body">
                                <h5 class="card-title">Active Retailers</h5>
                                <h2 id="activeRetailers">-</h2>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-info text-white">
                            <div class="card-body">
                                <h5 class="card-title">Monthly Revenue</h5>
                                <h2 id="monthlyRevenue">-</h2>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-warning text-white">
                            <div class="card-body">
                                <h5 class="card-title">Conversion Rate</h5>
                                <h2 id="conversionRate">-</h2>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Lead Pipeline -->
            <div class="col-md-8 mb-4">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5>Lead Pipeline</h5>
                        <button class="btn btn-primary btn-sm" onclick="showAddLeadModal()">Add Lead</button>
                    </div>
                    <div class="card-body">
                        <table class="table table-hover" id="leadsTable">
                            <thead>
                                <tr>
                                    <th>Company</th>
                                    <th>Contact</th>
                                    <th>Email</th>
                                    <th>Status</th>
                                    <th>Expected Volume</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Pipeline Stats -->
            <div class="col-md-4 mb-4">
                <div class="card">
                    <div class="card-header">
                        <h5>Pipeline Status</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-2">
                            <small class="text-muted">New Leads</small>
                            <div class="progress">
                                <div class="progress-bar bg-primary" role="progressbar" id="newProgress" style="width: 0%"></div>
                            </div>
                            <span id="newCount">0</span>
                        </div>
                        <div class="mb-2">
                            <small class="text-muted">Contacted</small>
                            <div class="progress">
                                <div class="progress-bar bg-info" role="progressbar" id="contactedProgress" style="width: 0%"></div>
                            </div>
                            <span id="contactedCount">0</span>
                        </div>
                        <div class="mb-2">
                            <small class="text-muted">Qualified</small>
                            <div class="progress">
                                <div class="progress-bar bg-warning" role="progressbar" id="qualifiedProgress" style="width: 0%"></div>
                            </div>
                            <span id="qualifiedCount">0</span>
                        </div>
                        <div class="mb-2">
                            <small class="text-muted">Converted</small>
                            <div class="progress">
                                <div class="progress-bar bg-success" role="progressbar" id="convertedProgress" style="width: 0%"></div>
                            </div>
                            <span id="convertedCount">0</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recent Orders -->
            <div class="col-md-6 mb-4">
                <div class="card">
                    <div class="card-header">
                        <h5>Recent Orders</h5>
                    </div>
                    <div class="card-body">
                        <table class="table table-sm" id="ordersTable">
                            <thead>
                                <tr>
                                    <th>Order ID</th>
                                    <th>Date</th>
                                    <th>Amount</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Inventory Overview -->
            <div class="col-md-6 mb-4">
                <div class="card">
                    <div class="card-header">
                        <h5>Inventory Overview</h5>
                    </div>
                    <div class="card-body">
                        <table class="table table-sm" id="inventoryTable">
                            <thead>
                                <tr>
                                    <th>Product</th>
                                    <th>Stock</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Lead Modal -->
    <div class="modal fade" id="addLeadModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add New Lead</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addLeadForm">
                        <div class="mb-3">
                            <label for="companyName" class="form-label">Company Name</label>
                            <input type="text" class="form-control" id="companyName" required>
                        </div>
                        <div class="mb-3">
                            <label for="contactPerson" class="form-label">Contact Person</label>
                            <input type="text" class="form-control" id="contactPerson" required>
                        </div>
                        <div class="mb-3">
                            <label for="email" class="form-label">Email</label>
                            <input type="email" class="form-control" id="email" required>
                        </div>
                        <div class="mb-3">
                            <label for="phone" class="form-label">Phone</label>
                            <input type="tel" class="form-control" id="phone">
                        </div>
                        <div class="mb-3">
                            <label for="location" class="form-label">Location</label>
                            <input type="text" class="form-control" id="location">
                        </div>
                        <div class="mb-3">
                            <label for="businessType" class="form-label">Business Type</label>
                            <select class="form-control" id="businessType">
                                <option value="">Select...</option>
                                <option value="grocery_store">Grocery Store</option>
                                <option value="supermarket">Supermarket</option>
                                <option value="convenience_store">Convenience Store</option>
                                <option value="restaurant">Restaurant</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="expectedVolume" class="form-label">Expected Volume</label>
                            <select class="form-control" id="expectedVolume">
                                <option value="low">Low</option>
                                <option value="medium" selected>Medium</option>
                                <option value="high">High</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="source" class="form-label">Lead Source</label>
                            <select class="form-control" id="source">
                                <option value="website" selected>Website</option>
                                <option value="referral">Referral</option>
                                <option value="cold_call">Cold Call</option>
                                <option value="trade_show">Trade Show</option>
                                <option value="social_media">Social Media</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="notes" class="form-label">Notes</label>
                            <textarea class="form-control" id="notes" rows="3"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="addLead()">Add Lead</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        async function loadDashboard() {
            try {
                // Load pipeline stats
                const pipelineResp = await fetch('/leads/stats/pipeline');
                const pipelineData = await pipelineResp.json();
                
                document.getElementById('totalLeads').textContent = pipelineData.total;
                document.getElementById('conversionRate').textContent = pipelineData.conversion_rate.toFixed(1) + '%';
                
                // Update pipeline progress bars
                updatePipelineProgress(pipelineData);
                
                // Load leads
                loadLeads();
                
                // Load retailers count
                const retailersResp = await fetch('/customers/manufacturer/retailers');
                const retailersData = await retailersResp.json();
                document.getElementById('activeRetailers').textContent = retailersData.length;
                
                // Load recent orders
                loadRecentOrders();
                
                // Load inventory overview
                loadInventoryOverview();
                
                // Mock revenue data
                document.getElementById('monthlyRevenue').textContent = '$45,230';
                
            } catch (error) {
                console.error('Error loading dashboard:', error);
            }
        }

        function updatePipelineProgress(stats) {
            const total = stats.total || 1;
            
            const updateProgress = (id, count) => {
                const percentage = (count / total) * 100;
                document.getElementById(id + 'Progress').style.width = percentage + '%';
                document.getElementById(id + 'Count').textContent = count;
            };
            
            updateProgress('new', stats.new || 0);
            updateProgress('contacted', stats.contacted || 0);
            updateProgress('qualified', stats.qualified || 0);
            updateProgress('converted', stats.converted || 0);
        }

        async function loadLeads() {
            try {
                const resp = await fetch('/leads/');
                const leads = await resp.json();
                
                const tbody = document.querySelector('#leadsTable tbody');
                tbody.innerHTML = '';
                
                leads.forEach(lead => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${lead.company_name}</td>
                        <td>${lead.contact_person}</td>
                        <td>${lead.email}</td>
                        <td><span class="badge bg-${getStatusColor(lead.status)}">${lead.status}</span></td>
                        <td>${lead.expected_volume}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary" onclick="updateLeadStatus(${lead.id}, getNextStatus('${lead.status}'))">
                                ${getStatusAction(lead.status)}
                            </button>
                            ${lead.status === 'qualified' ? `<button class="btn btn-sm btn-success" onclick="convertLead(${lead.id})">Convert</button>` : ''}
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            } catch (error) {
                console.error('Error loading leads:', error);
            }
        }

        function getStatusColor(status) {
            const colors = {
                'new': 'primary',
                'contacted': 'info', 
                'qualified': 'warning',
                'converted': 'success',
                'lost': 'danger'
            };
            return colors[status] || 'secondary';
        }

        function getStatusAction(status) {
            const actions = {
                'new': 'Contact',
                'contacted': 'Qualify',
                'qualified': 'Convert',
                'converted': 'Converted',
                'lost': 'Lost'
            };
            return actions[status] || 'Update';
        }

        function getNextStatus(currentStatus) {
            const nextStatus = {
                'new': 'contacted',
                'contacted': 'qualified',
                'qualified': 'qualified',
                'converted': 'converted',
                'lost': 'lost'
            };
            return nextStatus[currentStatus] || currentStatus;
        }

        async function updateLeadStatus(leadId, newStatus) {
            try {
                const resp = await fetch(`/leads/${leadId}`, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({status: newStatus})
                });
                
                if (resp.ok) {
                    loadDashboard(); // Refresh dashboard
                } else {
                    alert('Failed to update lead status');
                }
            } catch (error) {
                console.error('Error updating lead:', error);
            }
        }

        async function convertLead(leadId) {
            const password = prompt('Enter password for new retailer account:');
            if (!password) return;
            
            try {
                const resp = await fetch(`/leads/${leadId}/convert`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({password: password})
                });
                
                if (resp.ok) {
                    alert('Lead converted successfully!');
                    loadDashboard(); // Refresh dashboard
                } else {
                    const error = await resp.json();
                    alert('Failed to convert lead: ' + error.detail);
                }
            } catch (error) {
                console.error('Error converting lead:', error);
            }
        }

        function showAddLeadModal() {
            const modal = new bootstrap.Modal(document.getElementById('addLeadModal'));
            modal.show();
        }

        async function addLead() {
            const form = document.getElementById('addLeadForm');
            const formData = new FormData(form);
            
            const leadData = {
                company_name: document.getElementById('companyName').value,
                contact_person: document.getElementById('contactPerson').value,
                email: document.getElementById('email').value,
                phone: document.getElementById('phone').value,
                location: document.getElementById('location').value,
                business_type: document.getElementById('businessType').value,
                expected_volume: document.getElementById('expectedVolume').value,
                source: document.getElementById('source').value,
                notes: document.getElementById('notes').value
            };
            
            try {
                const resp = await fetch('/leads/', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(leadData)
                });
                
                if (resp.ok) {
                    const modal = bootstrap.Modal.getInstance(document.getElementById('addLeadModal'));
                    modal.hide();
                    form.reset();
                    loadDashboard(); // Refresh dashboard
                } else {
                    const error = await resp.json();
                    alert('Failed to add lead: ' + error.detail);
                }
            } catch (error) {
                console.error('Error adding lead:', error);
            }
        }

        async function loadRecentOrders() {
            try {
                const resp = await fetch('/orders');
                const orders = await resp.json();
                
                const tbody = document.querySelector('#ordersTable tbody');
                tbody.innerHTML = '';
                
                orders.slice(0, 5).forEach(order => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>#${order.id}</td>
                        <td>${order.order_date || 'N/A'}</td>
                        <td>$${order.total_amount}</td>
                        <td><span class="badge bg-${order.status === 'shipped' ? 'success' : 'warning'}">${order.status}</span></td>
                    `;
                    tbody.appendChild(tr);
                });
            } catch (error) {
                console.error('Error loading orders:', error);
            }
        }

        async function loadInventoryOverview() {
            try {
                const resp = await fetch('/products/');
                const products = await resp.json();
                
                const tbody = document.querySelector('#inventoryTable tbody');
                tbody.innerHTML = '';
                
                products.slice(0, 5).forEach(product => {
                    const tr = document.createElement('tr');
                    const status = product.current_stock_quantity < 20 ? 'Low' : 'Good';
                    const statusClass = status === 'Low' ? 'danger' : 'success';
                    
                    tr.innerHTML = `
                        <td>${product.name}</td>
                        <td>${product.current_stock_quantity}</td>
                        <td><span class="badge bg-${statusClass}">${status}</span></td>
                    `;
                    tbody.appendChild(tr);
                });
            } catch (error) {
                console.error('Error loading inventory:', error);
            }
        }

        // Load dashboard on page load
        loadDashboard();
    </script>
</body>
</html>